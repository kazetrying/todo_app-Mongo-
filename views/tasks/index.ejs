<%- include('../partials/header') %>
<%- include('../partials/navbar') %>

<div class="container py-4">
  <!-- Flash Messages -->
  <% if (success && success.length > 0) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill me-2"></i><%= success %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
  <% if (error && error.length > 0) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-circle-fill me-2"></i><%= error %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>

  <div class="row g-4">
    <!-- LEFT: Form thêm task + Stats -->
    <div class="col-lg-4">
      <!-- Stats -->
      <div class="row g-3 mb-4">
        <div class="col-6">
          <div class="stat-card" style="background: linear-gradient(135deg,#6366f1,#4f46e5)">
            <div style="font-size:1.8rem;font-weight:700"><%= tasks.length %></div>
            <div style="font-size:0.8rem;opacity:0.9">Tổng task</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card" style="background: linear-gradient(135deg,#10b981,#059669)">
            <div style="font-size:1.8rem;font-weight:700"><%= tasks.filter(t=>t.isCompleted).length %></div>
            <div style="font-size:0.8rem;opacity:0.9">Hoàn thành</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card" style="background: linear-gradient(135deg,#f59e0b,#d97706)">
            <div style="font-size:1.8rem;font-weight:700"><%= tasks.filter(t=>!t.isCompleted).length %></div>
            <div style="font-size:0.8rem;opacity:0.9">Chưa xong</div>
          </div>
        </div>
        <div class="col-6">
          <div class="stat-card" style="background: linear-gradient(135deg,#ef4444,#dc2626)">
            <%
              const todayStart = new Date(); todayStart.setHours(0,0,0,0);
              const todayCount = tasks.filter(t => new Date(t.createdAt) >= todayStart).length;
            %>
            <div style="font-size:1.8rem;font-weight:700"><%= todayCount %></div>
            <div style="font-size:0.8rem;opacity:0.9">Hôm nay</div>
          </div>
        </div>
      </div>

      <!-- Form thêm task -->
      <div class="card p-4">
        <h5 class="fw-bold mb-3"><i class="bi bi-plus-circle me-2 text-primary"></i>Thêm công việc mới</h5>
        <form action="/tasks" method="POST">
          <div class="mb-3">
            <input type="text" name="title" class="form-control" placeholder="Tên công việc..." required>
          </div>
          <div class="mb-3">
            <textarea name="description" class="form-control" rows="2" placeholder="Mô tả (tùy chọn)..."></textarea>
          </div>

          <% if (currentUser.role === 'admin') { %>
          <div class="mb-3">
            <label class="form-label fw-semibold small text-muted">
              <i class="bi bi-people me-1"></i>Phân công cho (Admin)
            </label>
            <select name="assigneeIds" class="form-select" multiple size="4" style="border-radius:10px;">
              <% allUsers.forEach(u => { %>
                <option value="<%= u._id %>" <%= u._id.toString() === currentUser.id.toString() ? 'selected' : '' %>>
                  <%= u.fullName %> (@<%= u.username %>) - <%= u.role %>
                </option>
              <% }); %>
            </select>
            <div class="form-text">Giữ Ctrl/Cmd để chọn nhiều người</div>
          </div>
          <% } %>

          <button type="submit" class="btn btn-primary w-100">
            <i class="bi bi-plus-lg me-2"></i>Thêm công việc
          </button>
        </form>
      </div>

      <!-- API Quick Reference (cho dev) -->
      <div class="card p-3 mt-3">
        <h6 class="fw-bold text-muted mb-2"><i class="bi bi-code-slash me-1"></i>API Endpoints</h6>
        <div class="d-flex flex-column gap-1">
          <a href="/tasks/api/getAllTasks" class="btn btn-outline-secondary btn-sm text-start" target="_blank">
            GET /api/getAllTasks
          </a>
          <a href="/tasks/api/getTodayTasks" class="btn btn-outline-secondary btn-sm text-start" target="_blank">
            GET /api/getTodayTasks
          </a>
          <a href="/tasks/api/getPendingTasks" class="btn btn-outline-secondary btn-sm text-start" target="_blank">
            GET /api/getPendingTasks
          </a>
          <a href="/tasks/api/getTasksByLastName/nguyễn" class="btn btn-outline-secondary btn-sm text-start" target="_blank">
            GET /api/getTasksByLastName/nguyễn
          </a>
        </div>
      </div>
    </div>

    <!-- RIGHT: Danh sách task -->
    <div class="col-lg-8">
      <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
        <h5 class="fw-bold mb-0"><i class="bi bi-list-task me-2 text-primary"></i>Danh sách công việc</h5>
        <!-- Filter buttons -->
        <div class="d-flex gap-2 flex-wrap">
          <a href="/tasks?filter=all" class="btn btn-outline-primary filter-btn <%= filter==='all'?'active':'' %>">Tất cả</a>
          <a href="/tasks?filter=pending" class="btn btn-outline-warning filter-btn <%= filter==='pending'?'active':'' %>">Chưa xong</a>
          <a href="/tasks?filter=completed" class="btn btn-outline-success filter-btn <%= filter==='completed'?'active':'' %>">Hoàn thành</a>
          <a href="/tasks?filter=today" class="btn btn-outline-info filter-btn <%= filter==='today'?'active':'' %>">Hôm nay</a>
        </div>
      </div>

      <!-- Task List (ul) -->
      <ul class="list-unstyled d-flex flex-column gap-3" id="taskList">
        <% if (tasks.length === 0) { %>
          <li class="text-center py-5 text-muted">
            <i class="bi bi-inbox" style="font-size:3rem;opacity:0.3;"></i>
            <p class="mt-2">Không có công việc nào</p>
          </li>
        <% } %>

        <% tasks.forEach(task => { %>
        <li class="card task-card <%= task.isCompleted ? 'completed' : 'pending' %> p-0">
          <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div class="flex-grow-1">
                <!-- Title -->
                <div class="d-flex align-items-center gap-2 mb-1">
                  <% if (task.isCompleted) { %>
                    <span class="badge bg-success"><i class="bi bi-check2 me-1"></i>Hoàn thành</span>
                  <% } else { %>
                    <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Đang làm</span>
                  <% } %>
                  <h6 class="fw-bold mb-0 <%= task.isCompleted ? 'text-decoration-line-through text-muted' : '' %>">
                    <%= task.title %>
                  </h6>
                </div>

                <% if (task.description) { %>
                  <p class="text-muted small mb-2"><%= task.description %></p>
                <% } %>

                <!-- Assignees -->
                <div class="d-flex align-items-center gap-1 mb-2 flex-wrap">
                  <small class="text-muted me-1"><i class="bi bi-people me-1"></i>Thực hiện:</small>
                  <% task.assignees.forEach(a => { %>
                    <% if (a.user) { %>
                      <span class="d-inline-flex align-items-center gap-1 badge <%= a.isDone ? 'bg-success' : 'bg-secondary' %>" style="font-size:0.75rem;font-weight:500;">
                        <span class="avatar" style="width:18px;height:18px;font-size:0.6rem;">
                          <%= a.user.fullName ? a.user.fullName[0].toUpperCase() : '?' %>
                        </span>
                        <%= a.user.fullName %>
                        <% if (a.isDone) { %><i class="bi bi-check2"></i><% } %>
                      </span>
                    <% } %>
                  <% }); %>
                </div>

                <!-- Progress Bar -->
                <div class="mb-2">
                  <div class="d-flex justify-content-between mb-1">
                    <small class="text-muted">Tiến độ hoàn thành</small>
                    <small class="fw-semibold text-primary"><%= task.progress %>%</small>
                  </div>
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" 
                         style="width: <%= task.progress %>%"
                         aria-valuenow="<%= task.progress %>" aria-valuemin="0" aria-valuemax="100">
                    </div>
                  </div>
                </div>

                <!-- Meta info -->
                <div class="d-flex gap-3 flex-wrap">
                  <small class="text-muted">
                    <i class="bi bi-person me-1"></i>Tạo bởi: <strong><%= task.createdBy ? task.createdBy.fullName : 'N/A' %></strong>
                  </small>
                  <small class="text-muted">
                    <i class="bi bi-calendar me-1"></i><%= new Date(task.createdAt).toLocaleDateString('vi-VN') %>
                  </small>
                  <% if (task.isCompleted && task.completedAt) { %>
                    <small class="text-success">
                      <i class="bi bi-check-circle me-1"></i>Xong lúc: <%= new Date(task.completedAt).toLocaleString('vi-VN') %>
                    </small>
                  <% } %>
                </div>
              </div>

              <!-- Action buttons -->
              <div class="d-flex flex-column gap-2">
                <!-- Toggle done (cho user hiện tại nếu được assign) -->
                <% if (task.myAssigneeId !== null || currentUser.role === 'admin') { %>
                  <form action="/tasks/<%= task._id %>/toggle" method="POST">
                    <button type="submit" class="btn btn-sm <%= task.myDone ? 'btn-success' : 'btn-outline-success' %>" 
                            title="<%= task.myDone ? 'Đánh dấu chưa xong' : 'Đánh dấu hoàn thành' %>">
                      <i class="bi bi-<%= task.myDone ? 'check2-circle' : 'circle' %>"></i>
                    </button>
                  </form>
                <% } %>

                <!-- Assign thêm người (Admin only) -->
                <% if (currentUser.role === 'admin') { %>
                  <button class="btn btn-sm btn-outline-primary" 
                          data-bs-toggle="modal" 
                          data-bs-target="#assignModal"
                          data-task-id="<%= task._id %>"
                          data-task-title="<%= task.title %>"
                          title="Phân công thêm">
                    <i class="bi bi-person-plus"></i>
                  </button>
                <% } %>

                <!-- Xóa task -->
                <% if (task.createdBy && task.createdBy._id && (task.createdBy._id.toString() === currentUser.id.toString() || currentUser.role === 'admin')) { %>
                  <form action="/tasks/<%= task._id %>/delete" method="POST" 
                        onsubmit="return confirm('Bạn có chắc muốn xóa công việc này?')">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </div>
        </li>
        <% }); %>
      </ul>
    </div>
  </div>
</div>

<!-- Modal Assign (Admin only) -->
<% if (currentUser.role === 'admin') { %>
<div class="modal fade" id="assignModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0" style="border-radius:16px;">
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold"><i class="bi bi-person-plus me-2 text-primary"></i>Phân công task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form action="" method="POST" id="assignForm">
        <div class="modal-body">
          <p class="text-muted mb-3">Task: <strong id="modalTaskTitle"></strong></p>
          <label class="form-label fw-semibold">Chọn user để phân công:</label>
          <select name="assigneeId" class="form-select" required>
            <% allUsers.forEach(u => { %>
              <option value="<%= u._id %>"><%= u.fullName %> (@<%= u.username %>) - <%= u.role %></option>
            <% }); %>
          </select>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Hủy</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-person-check me-2"></i>Phân công
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const assignModal = document.getElementById('assignModal');
  assignModal.addEventListener('show.bs.modal', function(event) {
    const btn = event.relatedTarget;
    const taskId = btn.getAttribute('data-task-id');
    const taskTitle = btn.getAttribute('data-task-title');
    document.getElementById('modalTaskTitle').textContent = taskTitle;
    document.getElementById('assignForm').action = `/tasks/${taskId}/assign`;
  });
</script>
<% } %>

<%- include('../partials/footer') %>
